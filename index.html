<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Fluency Coach – Automated WCPM</title>

<link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><rect width="64" height="64" rx="12" ry="12" fill="%230f2742"/><path d="M18 22h28M18 32h20M18 42h24" stroke="%2358c7ff" stroke-width="4" stroke-linecap="round"/></svg>'>

<style>
  :root{--bg:#0b1a2a;--card:#0f2742;--ink:#e7f2ff;--muted:#a9c6e8;--accent:#58c7ff;--ok:#19c37d;--warn:#ffb020;--bad:#ff5a5f}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{max-width:1100px;margin:auto;padding:24px}
  .grid{display:grid;gap:16px}
  .two{grid-template-columns:1fr 1fr}
  .card{background:var(--card);border:1px solid #1e3a5c;border-radius:16px;padding:16px;box-shadow:0 6px 16px rgba(0,0,0,.25)}
  h1{margin:0 0 6px;font-size:26px}
  .sub{margin:0;color:var(--muted)}
  label{font-weight:600}
  input,select,textarea,button{border-radius:12px;border:1px solid #2a4771;background:#0a1f39;color:var(--ink);padding:10px 12px}
  button{cursor:pointer}
  button.primary{background:linear-gradient(180deg,#169bf0,#116bb9);border:0}
  button:disabled{opacity:.6;cursor:not-allowed}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .meter{height:10px;background:#0a1f39;border:1px solid #2a4771;border-radius:999px;overflow:hidden}
  .bar{height:100%;width:0;background:linear-gradient(90deg,#3ff2a8,#12d6ff)}
  .passage{line-height:1.9;background:#0a1f39;border:1px solid #2a4771;border-radius:12px;padding:16px;min-height:180px;max-height:360px;overflow:auto}
  .word{padding:2px 4px;border-radius:6px;margin:0 1px;display:inline-block}
  .curr{outline:2px dashed var(--accent);background:#12355d}
  .ok{background:rgba(25,195,125,.25)}
  .err{background:rgba(255,90,95,.25)}
  .muted{color:var(--muted)}

  /* Compact KPIs under passage */
  .kpi{display:grid;grid-template-columns:repeat(4,minmax(120px,1fr));gap:8px}
  .kpi .box{background:#0a1f39;border:1px solid #2a4771;border-radius:10px;padding:8px;text-align:center}
  .kpi .label{font-size:12px;color:var(--muted)}
  .kpi .num{font-size:16px;font-weight:800}
  .status-line{font-size:12px;color:var(--muted);margin-top:6px}
  .badge{padding:2px 8px;border-radius:999px;font-size:12px}
  .b-ok{background:rgba(25,195,125,.2);border:1px solid #19c37d}
  .b-bad{background:rgba(255,90,95,.2);border:1px solid #ff5a5f}
  .tiny{font-size:12px}
</style>
</head>
<body>
<div class="wrap grid">
  <div class="card grid">
    <div>
      <h1>Fluency Coach – Automated WCPM</h1>
      <p class="sub">One-minute oral reading with automatic word matching (if speech recognition is supported). Data stays in this browser.</p>
    </div>

    <!-- Inputs row -->
    <div class="row">
      <div>
        <label for="student">Student</label><br/>
        <input id="student" placeholder="e.g., Alex R." style="min-width:220px" />
      </div>
      <div>
        <label for="grade">Grade</label><br/>
        <select id="grade"></select>
      </div>
      <div>
        <label for="passage">Passage</label><br/>
        <select id="passage" style="min-width:320px"></select>
      </div>
      <div>
        <label for="target">Target WCPM</label><br/>
        <input id="target" type="number" value="110" style="width:120px" />
      </div>
    </div>

    <!-- Start/Stop + meter -->
    <div class="row">
      <button class="primary" id="btnStart">Start 60s</button>
      <button id="btnStop" disabled>Stop</button>
      <button id="btnReset">Reset</button>
    </div>
    <div class="meter"><div class="bar" id="bar"></div></div>

    <!-- Passage directly under Start -->
    <div>
      <label class="tiny muted">Passage</label>
      <div id="passageView" class="passage"></div>
      <div class="status-line" id="status">Idle</div>
      <!-- Compact KPIs below passage -->
      <div class="kpi" aria-label="metrics">
        <div class="box"><div class="label">Words Attempted</div><div class="num" id="twa">0</div></div>
        <div class="box"><div class="label">Correct Words</div><div class="num" id="correct">0</div></div>
        <div class="box"><div class="label">Errors</div><div class="num" id="errors">0</div></div>
        <div class="box"><div class="label">WCPM</div><div class="num" id="wcpm">0</div></div>
      </div>
      <div class="tiny muted" style="margin-top:6px">Tip: If auto-matching is unavailable, click words to toggle correct/error.</div>
    </div>
  </div>

  <!-- Results table stays in its own card -->
  <div class="card grid">
    <h3 style="margin:0">Results</h3>
    <div class="row">
      <button id="btnSave" class="primary" disabled>Save Result</button>
      <button id="btnExport">Export CSV</button>
      <span class="muted" id="savedCount">0 records</span>
    </div>
    <div style="overflow:auto">
      <table id="tbl"><thead><tr>
        <th>Date</th><th>Student</th><th>Grade</th><th>Passage</th><th>Attempted</th><th>Correct</th><th>Errors</th><th>WCPM</th><th>Acc%</th><th>Target</th>
      </tr></thead><tbody></tbody></table>
    </div>
  </div>
</div>

<script>
/**** Longer Passage Library (5× G5, 5× G6) ************************************/
const PASSAGES = [
  { id:"g5_1", grade:"5", title:"Saving the Science Fair",
    text:`Jamal planned a solar oven for the science fair, but the day turned cloudy and cool. He worried that his project would fail. Then he remembered a tip from his teacher about reflecting light. Using foil, he built a wide mirror to direct sunlight toward the oven. The temperature finally rose enough to melt chocolate chips, and the judges smiled. Jamal explained how small changes can improve a design, and he promised to share his notes with classmates. Although he did not win first place, he learned more from the struggle than he expected, and he walked home proud.` },
  { id:"g5_2", grade:"5", title:"Mapmakers at Work",
    text:`Long before satellites, mapmakers traveled by foot, horse, or boat and measured the world with ropes and angles. They drew coastlines as carefully as they could, but storms often changed the shore. Today, scientists use lasers and radar to scan entire valleys in a single flight. Computers layer information onto digital maps, adding roads, rivers, and even wildfire risk. Yet old maps still matter. They show how towns grew, where trails once crossed, and which place names were forgotten. A good map tells a story about the land, and the story keeps growing as people add new chapters.` },
  { id:"g5_3", grade:"5", title:"The Library on Wheels",
    text:`On summer Saturdays, a bright blue bus parks near the playground. It is our traveling library. Children trade finished books for fresh ones, and the driver stamps cards with cheerful thumps. Ms. Rivera recommends mysteries to one reader and quiet poetry to another. Sometimes neighbors drop off donations, and sometimes the bus brings laptops so families can apply for jobs. The library on wheels is more than shelves with wheels; it is a promise that stories can find you wherever you live. When the bus pulls away, it leaves a trail of ideas that lasts the whole week.` },
  { id:"g5_4", grade:"5", title:"The Storm Drill",
    text:`When thunder rolled over the hills, our class practiced a storm drill. We moved quickly but calmly into the hallway and crouched against the wall. The principal squeezed past, checking doors and reminding everyone to stay away from windows. After a few minutes, the power flickered and the building grew quiet. I listened to the rain brush the roof like a broom. Then the all-clear bell rang, and we returned to class. The drill took only ten minutes, but it made us feel prepared. Nobody can stop a storm, yet we can learn to face it safely together.` },
  { id:"g5_5", grade:"5", title:"The River Clean-Up",
    text:`Every spring our town hosts a river clean-up. Volunteers gather at the boat ramp with gloves, buckets, and tall boots. This year the water was low, so we found old cans wedged between stones and a bicycle tangled in vines. A wildlife expert explained how plastic breaks into tiny pieces that fish can swallow. We sorted the trash into bins and weighed each bag. By noon the piles looked smaller, and the riverbank looked wider. The current kept sliding past, silver and patient. Cleaning once does not solve the problem, but it shows the river we will keep coming back.` },
  { id:"g6_1", grade:"6", title:"A Museum at Night",
    text:`Our class slept under the dinosaur skeletons during a museum overnight. After the lights dimmed, a guide led us through exhibits using small flashlights. The beams slid over fossils, ship models, and a woven basket older than our town. In the planetarium, the ceiling filled with stars, and a scientist explained how light takes years to reach our eyes. Back in the main hall, we unrolled sleeping bags beside the giant bones. The building felt different at night, like a library holding its breath. In the morning, the doors opened and the museum spoke again in cheerful daytime voices.` },
  { id:"g6_2", grade:"6", title:"The Bridge Contest",
    text:`For engineering club we built bridges from thin strips of wood and glue. The rules were simple: the bridge had to span thirty centimeters and hold as much weight as possible. Our first try looked neat but snapped in the middle. We studied photos of real trusses and noticed how triangles share the load. The next version used fewer pieces arranged more wisely. During testing, the bridge sagged, trembled, and then surprised us by holding a stack of textbooks. Strength is not only about more material; it is also about design, patience, and learning from collapse.` },
  { id:"g6_3", grade:"6", title:"Signals from the Sea",
    text:`On a foggy morning the harbor sounded like a conversation. A bell buoy clanged slowly as waves rolled under it. The ferry answered with a low horn, and gulls signed their names on the air. Scientists study these signals to keep ships safe. Some install underwater microphones to record whale songs so captains can steer clear. Others tag turtles with tiny transmitters to map their routes. The ocean speaks in clicks, rumbles, and rhythms. When we listen carefully, we learn where creatures travel, when storms rise, and how busy humans can be without meaning to crowd the sea.` },
  { id:"g6_4", grade:"6", title:"The Long Walk for Water",
    text:`Amina wakes before sunrise and ties two yellow jugs to a cart. She and her brother walk dusty paths to the community well. The trip takes an hour each way. At school, Amina likes science and wonders how engineers might bring a pipe to her village. A visiting group teaches students to build simple filters with gravel, sand, and charcoal. Clean water should not be rare, Amina says, but it still feels like treasure. When the rainy season finally arrives, the well runs faster, and the walk home is lighter, even though the jugs are full.` },
  { id:"g6_5", grade:"6", title:"Newsroom Morning",
    text:`The student newsroom hums before the first bell. Reporters finish interviews, photographers check batteries, and the editor lists headlines on a whiteboard. Today we are covering the robotics team, a budget vote, and a local bakery that hires teens. Our adviser reminds us to verify names and facts, even when a story seems obvious. After lunch, layout begins. We trim sentences, choose captions, and balance serious pieces with lighter ones. When the issue finally prints, the ink smells like rain. We stack copies by the office door, proud of the small city of voices we built.` }
];

/**** Utility *****************************************************************/
const $ = id => document.getElementById(id);
const clean = s => (s||"").toLowerCase().replace(/[“”„”\u2019'".,!?;:()\[\]{}]/g,"");
function endsPunct(w){ return /[.,!?;:]$/.test(w||""); }
function splitWords(text){ return text.replace(/\s+/g,' ').trim().split(' ').map(w=>w.trim()).filter(Boolean); }
function similarity(a,b){
  a = clean(a); b = clean(b);
  if(!a || !b) return 0;
  if(a===b) return 1;
  if((a.startsWith(b) || b.startsWith(a)) && Math.abs(a.length-b.length)<=1) return .85;
  return 0;
}

/**** State *******************************************************************/
let words = [], marks = [], curr = 0;
let running = false, t0=0, timerId=null, total=60;
let recog=null, recognizing=false;
let lastChangeTime = 0, lastChangedIdx = -1, nonMatchStreak = 0;
const PUNCT_COOLOFF_MS = 250; let cooloffUntil = 0;
const STOPWORDS = new Set(["oh","uh","um","er","ah","uhh","umm","i","mean","like","so","yeah","okay","ok","sorry"]);

/**** Build selectors *********************************************************/
(function initSelectors(){
  const grades = [...new Set(PASSAGES.map(p=>p.grade))].sort((a,b)=>+a-+b);
  grades.forEach(g=>{ const opt=document.createElement('option'); opt.value=g; opt.textContent=g; $('grade').appendChild(opt); });
  $('grade').value = "5";
  renderPassageList();
})();
function renderPassageList(){
  const g = $('grade').value;
  $('passage').innerHTML='';
  PASSAGES.filter(p=>p.grade===g).forEach(p=>{
    const wc = splitWords(p.text).length;
    const opt=document.createElement('option');
    opt.value=p.id; opt.textContent=`${p.title} — ~${wc} words`;
    $('passage').appendChild(opt);
  });
  loadPassage($('passage').value);
}
$('grade').addEventListener('change', renderPassageList);
$('passage').addEventListener('change', e=> loadPassage(e.target.value));

function loadPassage(id){
  const p = PASSAGES.find(x=>x.id===id) || PASSAGES[0];
  words = splitWords(p.text);
  marks = new Array(words.length).fill(0);
  curr = 0; nonMatchStreak=0; cooloffUntil=0;
  updateKPIs();
  renderPassageView();
  $('status').textContent = `${p.title} (Grade ${p.grade})`;
}

/**** Rendering ***************************************************************/
function scrollToCurrent(){
  const el = document.querySelector('#passageView .curr');
  if (el) el.scrollIntoView({block:'center', inline:'nearest', behavior:'smooth'});
}
function renderPassageView(){
  const frag = document.createDocumentFragment();
  words.forEach((w,i)=>{
    const span = document.createElement('span');
    span.className = 'word' + (i===curr?' curr':'') + (marks[i]===1?' ok':'') + (marks[i]===-1?' err':'');
    span.textContent = w;
    span.dataset.idx = i;
    span.addEventListener('click', ()=>{
      if(!running) return;
      if(marks[i]===1){ marks[i] = -1; if(i>=curr) curr=i+1; }
      else if(marks[i]===-1){ marks[i] = 0; }
      else { marks[i] = 1; if(i>=curr) curr=i+1; }
      renderPassageView(); updateKPIs();
    });
    frag.appendChild(span); frag.appendChild(document.createTextNode(' '));
  });
  const pv = $('passageView'); pv.innerHTML=''; pv.appendChild(frag);
  scrollToCurrent();
}

/**** Timer *******************************************************************/
function startTimer(){ t0 = performance.now(); timerId = requestAnimationFrame(tick); }
function tick(ts){
  const elapsed = (ts - t0)/1000;
  $('bar').style.width = Math.min(100,(elapsed/total)*100)+"%";
  if(elapsed>=total){ stopAll(); return; }
  timerId = requestAnimationFrame(tick);
}
function stopTimer(){ if(timerId){ cancelAnimationFrame(timerId); timerId=null; } }

/**** Speech Recognition (interim + final + punctuation cooloff) **************/
function startRecog(){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition; 
  if(!SR){ $('status').textContent='ASR not available. Use manual clicks if needed.'; return; }
  recog = new SR();
  recog.lang='en-US';
  recog.continuous = true;
  recog.interimResults = true;
  recognizing=true;

  let lastInterimAt = 0;
  recog.onresult = e => {
    let finals = "", inter = "";
    for (let i=e.resultIndex; i<e.results.length; i++){
      const tr = e.results[i][0].transcript;
      if (e.results[i].isFinal) finals += " " + tr; else inter += " " + tr;
    }
    const now = performance.now();
    if (inter.trim() && now - lastInterimAt > 120) { consumeTranscript(inter); lastInterimAt = now; }
    if (finals.trim()) consumeTranscript(finals);
  };

  recog.onerror = ()=>{ $('status').textContent='ASR error (continue manual if needed).'; };
  recog.onend = ()=>{ recognizing=false; };
  try{ recog.start(); }catch{ recognizing=false; }
}

function consumeTranscript(txt){
  const tokens = splitWords(txt).map(clean);
  let moved = false;
  const now = performance.now();

  for(const t of tokens){
    if(!t) continue;
    if(STOPWORDS.has(t)) continue;

    const inCooloff = now < cooloffUntil;

    // self correction
    if(curr>0 && marks[curr-1]===-1 && similarity(t, words[curr-1])>=0.85 && (now - lastChangeTime) < 3000){
      marks[curr-1] = 1; lastChangedIdx = curr-1; lastChangeTime = now; moved = true;
      renderPassageView(); updateKPIs(); continue;
    }

    if(curr>=words.length) break;
    const target = words[curr];
    const sim = similarity(t, target);

    if(sim>=0.85){
      marks[curr]=1; curr++; moved=true; nonMatchStreak = 0;
      lastChangedIdx = curr-1; lastChangeTime = now;
      if(endsPunct(target)) { cooloffUntil = performance.now() + PUNCT_COOLOFF_MS; }
    } else {
      if (inCooloff) continue; // don't punish first word after punctuation
      nonMatchStreak++;
      if(curr+1 < words.length && similarity(t, words[curr+1])>=0.85 && nonMatchStreak>=2){
        marks[curr] = -1; curr++; moved=true; nonMatchStreak = 0;
        lastChangedIdx = curr-1; lastChangeTime = now;
        if(endsPunct(words[curr-1])) { cooloffUntil = performance.now() + PUNCT_COOLOFF_MS; }
      }
    }
  }
  if(moved){ renderPassageView(); updateKPIs(); }
}

/**** KPIs ********************************************************************/
function updateKPIs(){
  const attempted = Math.max(curr, marks.findLastIndex ? (marks.findLastIndex(m=>m!==0)+1||0) : curr);
  const correct = marks.filter(m=>m===1).length;
  const errors = marks.filter(m=>m===-1).length;
  const wcpm = Math.max(0, correct);
  $('twa').textContent = attempted;
  $('correct').textContent = correct;
  $('errors').textContent = errors;
  $('wcpm').textContent = wcpm;
}

/**** Controls ****************************************************************/
function startAll(){
  if(running) return;
  running = true; $('status').textContent='Recording & matching…';
  document.getElementById('btnStart').disabled = true;
  document.getElementById('btnStop').disabled = false;
  document.getElementById('btnSave').disabled = true;
  marks.fill(0); curr=0; nonMatchStreak=0; cooloffUntil=0;
  renderPassageView(); updateKPIs();
  startTimer(); startRecog();
}
function stopAll(){
  if(!running) return;
  running=false; $('status').textContent='Stopped.';
  document.getElementById('btnStart').disabled=false;
  document.getElementById('btnStop').disabled=true;
  document.getElementById('btnSave').disabled=false;
  stopTimer(); if(recognizing && recog){ try{recog.stop();}catch{} recognizing=false; }
  updateKPIs();
}
function resetAll(){
  running=false; stopTimer(); if(recognizing && recog){ try{recog.stop();}catch{} recognizing=false; }
  marks.fill(0); curr=0; nonMatchStreak=0; cooloffUntil=0; $('bar').style.width='0%'; $('status').textContent='Idle';
  document.getElementById('btnStart').disabled=false;
  document.getElementById('btnStop').disabled=true;
  document.getElementById('btnSave').disabled=true;
  renderPassageView(); updateKPIs();
}
document.getElementById('btnStart').onclick = startAll;
document.getElementById('btnStop').onclick = stopAll;
document.getElementById('btnReset').onclick = resetAll;

/**** Save / Export ***********************************************************/
function getSaved(){ return JSON.parse(localStorage.getItem('fc_records')||'[]'); }
function setSaved(arr){ localStorage.setItem('fc_records', JSON.stringify(arr)); $('savedCount').textContent = `${arr.length} records`; renderTable(arr); }

document.getElementById('btnSave').onclick = ()=>{
  const p = PASSAGES.find(x=>x.id=== $('passage').value);
  const attempted = Math.max(curr, marks.findLastIndex ? (marks.findLastIndex(m=>m!==0)+1||0) : curr);
  const correct = marks.filter(m=>m===1).length;
  const errors = marks.filter(m=>m===-1).length;
  const wcpm = Math.max(0, correct);
  const acc = attempted? Math.round(100*correct/attempted):0;
  const row = {
    time: new Date().toISOString(),
    student: $('student').value||'Unknown',
    grade: $('grade').value,
    passage_id: p.id,
    passage_title: p.title,
    attempted, correct, errors, wcpm, accuracy: acc,
    target: +$('target').value||0
  };
  const arr = getSaved(); arr.push(row); setSaved(arr);
};

document.getElementById('btnExport').onclick = ()=>{
  const rows = getSaved(); if(!rows.length){ alert('No records to export.'); return; }
  const headers = ["time","student","grade","passage_id","passage_title","attempted","correct","errors","wcpm","accuracy","target"];
  const esc = v=>`"${String(v).replace(/"/g,'""')}"`;
  const csv = [headers.join(',')].concat(rows.map(r=>headers.map(h=>esc(r[h]??'')).join(','))).join('\r\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8'});
  const url = URL.createObjectURL(blob); const a=document.createElement('a');
  a.href=url; a.download='fluency_records.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
};

function renderTable(rows){
  const tb = document.querySelector('#tbl tbody');
  tb.innerHTML = rows.map(r=>{
    const good = r.target && r.wcpm>=r.target;
    return `<tr>
      <td>${new Date(r.time).toLocaleString()}</td>
      <td>${r.student}</td>
      <td>${r.grade}</td>
      <td>${r.passage_title}</td>
      <td>${r.attempted}</td>
      <td>${r.correct}</td>
      <td>${r.errors}</td>
      <td>${r.wcpm} ${r.target?`<span class="badge ${good?'b-ok':'b-bad'}">${good?'meets':'below'}</span>`:''}</td>
      <td>${r.accuracy}%</td>
      <td>${r.target||''}</td>
    </tr>`;
  }).join('');
}

// boot
setSaved(getSaved());
</script>
</body>
</html>
